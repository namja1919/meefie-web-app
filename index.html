<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Meefie - AI Celebrity Detection</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-900 text-white">
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useRef, useEffect } = React;

    const App = () => {
      const [capturedImage, setCapturedImage] = useState(null);
      const [detectionProgress, setDetectionProgress] = useState(0);
      const [detectionResults, setDetectionResults] = useState([]);
      const [showDetection, setShowDetection] = useState(false);
      const [cameraReady, setCameraReady] = useState(false);

      const videoRef = useRef(null);
      const canvasRef = useRef(null);

      const celebrityDatabase = [
        { name: 'Leonardo DiCaprio' },
        { name: 'BeyoncÃ©' },
        { name: 'Tom Hanks' },
        { name: 'Scarlett Johansson' }
      ];

      useEffect(() => {
        const startCamera = async () => {
          try {
            const stream = await navigator.mediaDevices.getUserMedia({
              video: { facingMode: 'user' }
            });
            if (videoRef.current) {
              videoRef.current.srcObject = stream;
              // Wait for video metadata to load
              videoRef.current.onloadedmetadata = () => {
                videoRef.current.play();
                setCameraReady(true);
              };
            }
          } catch (err) {
            alert('Camera access denied: ' + err.message);
          }
        };
        startCamera();
        
        return () => {
          if (videoRef.current?.srcObject) {
            videoRef.current.srcObject.getTracks().forEach(t => t.stop());
          }
        };
      }, []);

      const stopCamera = () => {
        if (videoRef.current?.srcObject) {
          videoRef.current.srcObject.getTracks().forEach(t => t.stop());
          videoRef.current.srcObject = null;
        }
      };

      const capturePhoto = () => {
        if (!cameraReady) {
          alert("Camera not ready yet. Please wait a moment.");
          return;
        }
        
        const video = videoRef.current;
        const canvas = canvasRef.current;
        const ctx = canvas.getContext('2d');
        
        // Use safe dimensions (default to 640x480 if metadata not available)
        const width = video.videoWidth || 640;
        const height = video.videoHeight || 480;
        
        canvas.width = width;
        canvas.height = height;
        ctx.drawImage(video, 0, 0, width, height);
        const imageData = canvas.toDataURL('image/jpeg');
        setCapturedImage(imageData);
        stopCamera();
        setTimeout(() => startDetection(), 800);
      };

      const startDetection = () => {
        setShowDetection(true);
        setDetectionProgress(0);
        let progress = 0;
        const interval = setInterval(() => {
          progress += 5;
          setDetectionProgress(progress);
          if (progress >= 100) {
            clearInterval(interval);
            const found = Math.random() < 0.7;
            if (found) {
              const celeb = celebrityDatabase[Math.floor(Math.random() * celebrityDatabase.length)];
              setDetectionResults([celeb]);
              alert(`Celebrity detected: ${celeb.name}`);
            } else {
              alert('No celebrity detected.');
            }
            setShowDetection(false);
          }
        }, 100);
      };

      return (
        <div className="min-h-screen flex flex-col items-center justify-center p-4">
          <h1 className="text-3xl font-bold mb-6">Meefie AI Celebrity Detection</h1>

          <div className="camera-container relative w-full max-w-lg">
            <video 
              ref={videoRef} 
              autoPlay 
              playsInline 
              muted 
              className="w-full rounded-xl"
            />
            
            {!cameraReady && (
              <div className="absolute inset-0 bg-gray-800 bg-opacity-75 flex flex-col items-center justify-center">
                <div className="w-10 h-10 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-3"></div>
                <p className="text-white">Loading camera...</p>
              </div>
            )}
            
            <div className="flex justify-center gap-4 mt-4">
              <button 
                onClick={capturePhoto}
                disabled={!cameraReady}
                className={`bg-white text-yellow-600 px-4 py-2 rounded-full ${!cameraReady ? 'opacity-50 cursor-not-allowed' : ''}`}
              >
                Capture
              </button>
            </div>
            <canvas ref={canvasRef} className="hidden"></canvas>
          </div>

          {showDetection && (
            <div className="mt-8 text-center">
              <h2 className="text-xl font-semibold mb-2">Scanning Photo...</h2>
              <div className="w-full max-w-sm h-2 bg-gray-700 rounded-full overflow-hidden">
                <div className="bg-blue-400 h-full transition-all duration-300" style={{ width: `${detectionProgress}%` }}></div>
              </div>
              {capturedImage && (
                <div className="relative w-64 h-64 mt-4">
                  <img src={capturedImage} className="w-full h-full object-cover rounded-xl" />
                  <div className="absolute inset-0 animate-pulse bg-gradient-to-b from-transparent via-cyan-300 to-transparent opacity-30"></div>
                </div>
              )}
            </div>
          )}

          {capturedImage && !showDetection && (
            <div className="mt-8">
              <img src={capturedImage} alt="Captured" className="rounded-xl max-w-md" />
              <button onClick={() => window.location.reload()} className="block mt-4 bg-yellow-500 text-black px-4 py-2 rounded-full">
                Take Another
              </button>
            </div>
          )}
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
